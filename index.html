<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›®æ¨™é”æˆã°ã‚“ãã†è€…ï¼ˆ100%ç‰ˆï¼‰</title>
    <!-- Tailwind CSS ã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ³ãƒˆã¨åŸºæœ¬è¨­å®š */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* è½ã¡ç€ã„ãŸãƒ©ã‚¤ãƒˆãƒ–ãƒ«ãƒ¼ã‚°ãƒ¬ãƒ¼ã®èƒŒæ™¯ */
        }
        .container-box {
            max-width: 900px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 1.5rem; /* ã‚ˆã‚Šãƒ¢ãƒ€ãƒ³ãªè§’ä¸¸ */
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
        }
        .btn-primary {
            background-color: #3b82f6; /* Blue 500 */
            color: white;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Blue 600 */
            transform: translateY(-1px);
        }
        .task-item {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
        }
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2.5rem;
            border-radius: 1rem;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 10, 0, 0.1);
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-open .modal-content {
            transform: scale(1);
        }
        .loading-spinner {
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* é€²æ—ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .progress-bar {
            height: 10px;
            border-radius: 9999px;
            background-color: #e5e7eb;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-out;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="main-app" class="container-box">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-900 leading-tight">
                ç›®æ¨™é”æˆã°ã‚“ãã†è€…
            </h1>
            <p class="text-lg text-gray-500 mt-2">AIãŒã‚ãªãŸã®ç›®æ¨™é”æˆã‚’æœ€åˆã‹ã‚‰æœ€å¾Œã¾ã§ã—ã£ã‹ã‚Šã¨ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ï¼è¨ˆç”»ä½œæˆã‹ã‚‰é€²æ—ç®¡ç†ã€ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ç¶­æŒã¾ã§ãŠä»»ã›ãã ã•ã„ã€‚</p>
        </header>

        <!-- ç›®æ¨™å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div id="input-section" class="mb-12 p-8 bg-blue-50 border-l-8 border-blue-400 rounded-xl">
            <h2 class="text-2xl font-bold text-blue-800 mb-4">ğŸ“ æ–°ã—ã„ç›®æ¨™ã¨æ¡ä»¶ã‚’å…¥åŠ›</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">ç›®æ¨™ã®ç¨®é¡ã‚’é¸æŠ</label>
                <select id="goal-type-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-800 shadow-sm">
                    <option value="general">ä¸€èˆ¬çš„ãªç›®æ¨™ (ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã€è¶£å‘³ãªã©)</option>
                    <option value="exam">å—é¨“ãƒ»è³‡æ ¼è©¦é¨“ã®ç›®æ¨™</option>
                    <option value="business">ãƒ“ã‚¸ãƒã‚¹ãƒ»ã‚­ãƒ£ãƒªã‚¢ã®ç›®æ¨™ (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€å–¶æ¥­æˆç¸¾ãªã©)</option>
                </select>
            </div>

            <!-- ä¸€èˆ¬çš„ãªç›®æ¨™å…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div id="general-goal-fields" class="space-y-4">
                <input type="text" id="wish-input" placeholder="ç›®æ¨™ (ä¾‹: è‹±èªã‚’æµæš¢ã«è©±ã›ã‚‹ã‚ˆã†ã«ãªã‚‹)" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-800 shadow-sm">
                <input type="text" id="criterion-input" placeholder="é”æˆæ¡ä»¶ (ä¾‹: å¤–å›½äººã¨30åˆ†ä¼šè©±ã§ãã‚‹)" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-800 shadow-sm">
                <input type="date" id="deadline-input" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-800 shadow-sm">
            </div>

            <!-- å—é¨“ãƒ»è³‡æ ¼è©¦é¨“ç›®æ¨™å…¥åŠ›ã‚¨ãƒªã‚¢ (æœ€åˆã¯éè¡¨ç¤º) -->
            <div id="exam-goal-fields" class="space-y-4 hidden">
                <input type="text" id="exam-name-input" placeholder="è©¦é¨“åãƒ»è³‡æ ¼å (ä¾‹: å¤§å­¦å…¥å­¦å…±é€šãƒ†ã‚¹ãƒˆã€TOEIC)" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-800 shadow-sm">
                <input type="text" id="target-score-input" placeholder="ç›®æ¨™ç‚¹æ•°ãƒ»ç›®æ¨™ãƒ©ãƒ³ã‚¯ (ä¾‹: 700ç‚¹ã€Aåˆ¤å®š)" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-800 shadow-sm">
                <input type="date" id="exam-date-input" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-800 shadow-sm">
            </div>
            
            <!-- ãƒ“ã‚¸ãƒã‚¹ç›®æ¨™å…¥åŠ›ã‚¨ãƒªã‚¢ (æœ€åˆã¯éè¡¨ç¤º) -->
            <div id="business-goal-fields" class="space-y-4 hidden">
                <input type="text" id="business-target-input" placeholder="ç›®æ¨™ (ä¾‹: æ–°è¦é¡§å®¢ã‚’20ç¤¾ç²å¾—ã™ã‚‹ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æˆåŠŸã•ã›ã‚‹)" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-800 shadow-sm">
                <input type="text" id="business-kpi-input" placeholder="é”æˆæŒ‡æ¨™/KPI (ä¾‹: æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹ã®å£²ä¸Šã‚’15%å‘ä¸Šã•ã›ã‚‹)" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-800 shadow-sm">
                <input type="date" id="business-deadline-input" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-800 shadow-sm">
            </div>


            <button id="add-wish-button" class="btn-primary px-6 py-3 rounded-xl font-semibold w-full flex items-center justify-center mt-6 shadow-md hover:shadow-lg">
                ğŸš€ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«é€²ã‚€ & AIã«æœ€å¼·ã®è¡Œå‹•è¨ˆç”»ã‚’ç”Ÿæˆã—ã¦ã‚‚ã‚‰ã†
            </button>
            
        </div>

        <!-- ç›®æ¨™ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="wishes-list" class="space-y-8">
            <!-- ç›®æ¨™ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </div>

        <!-- ç›®æ¨™ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="empty-state" class="text-center p-12 border-4 border-dashed border-gray-300 rounded-xl bg-gray-50 mt-12" style="display: none;">
            <p class="text-2xl text-gray-500 font-semibold">ã¾ãšã¯ã€ã‚ãªãŸã®ã€Œçµ¶å¯¾ã«å¶ãˆãŸã„ã“ã¨ã€ã‚’å…¥åŠ›ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
            <p class="text-gray-400 mt-2">ç›®æ¨™ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€AIãŒæœ€é©ãªè¨ˆç”»ä½œæˆã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚</p>
        </div>
        
    </div>

    <!-- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="questionnaire-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">ç›®æ¨™é”æˆã®ãŸã‚ã®è©³ç´°è¨­å®š (5ã¤ã®è³ªå•)</h3>
            <p class="text-gray-600 mb-6">ã‚ãªãŸã«åˆã£ãŸè¡Œå‹•è¨ˆç”»ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®è³ªå•ã«ãŠç­”ãˆãã ã•ã„ã€‚</p>
            
            <div id="questions-container" class="space-y-6">
                <!-- è³ªå• 1: ç›®æ¨™ã®ã‚¿ã‚¤ãƒ—ã¨åˆ†é‡ (å‹•çš„ã«å¤‰åŒ–) -->
                <div>
                    <label id="q1-label" class="block text-lg font-medium text-gray-700 mb-2">1. ã‚ãªãŸã®ç›®æ¨™ã®ä¸»ãªåˆ†é‡ã¯ï¼Ÿ</label>
                    <select id="q1-field" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯JSã§è¨­å®šã•ã‚Œã¾ã™ -->
                    </select>
                </div>

                <!-- è³ªå• 2: ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«ã¨é–‹å§‹åœ°ç‚¹ -->
                <div>
                    <label id="q2-label" class="block text-lg font-medium text-gray-700 mb-2">2. ç›®æ¨™åˆ†é‡ã«ãŠã‘ã‚‹ã‚ãªãŸã®ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«ã¯ï¼Ÿ</label>
                    <select id="q2-level" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="beginner">å…¨ãã®åˆå¿ƒè€… (åŸºç¤ã‹ã‚‰å­¦ã³ãŸã„)</option>
                        <option value="intermediate">ä¸­ç´šè€… (çµŒé¨“ã¯ã‚ã‚‹ãŒåœæ»ã—ã¦ã„ã‚‹)</option>
                        <option value="advanced">ä¸Šç´šè€… (æœ€å¾Œã®å£ã‚’ä¹—ã‚Šè¶ŠãˆãŸã„)</option>
                    </select>
                </div>

                <!-- è³ªå• 3: ç¢ºä¿ã§ãã‚‹æ™‚é–“ (ãƒªã‚½ãƒ¼ã‚¹) -->
                <div>
                    <label class="block text-lg font-medium text-gray-700 mb-2">3. 1æ—¥ã«ç¢ºä¿ã§ãã‚‹å¹³å‡çš„ãªå­¦ç¿’ãƒ»ä½œæ¥­æ™‚é–“ã¯ï¼Ÿ</label>
                    <select id="q3-time" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="short">30åˆ†æœªæº€ (ã™ãã¾æ™‚é–“)</option>
                        <option value="medium">30åˆ†ã€œ1æ™‚é–“ (æ¯æ—¥ç¢ºå®Ÿã«)</option>
                        <option value="long">1æ™‚é–“ã€œ2æ™‚é–“ (é›†ä¸­ã—ã¦å–ã‚Šçµ„ã‚€)</option>
                        <option value="intensive">2æ™‚é–“ä»¥ä¸Š (é›†ä¸­çš„ãªå­¦ç¿’æœŸé–“)</option>
                    </select>
                </div>
                
                <!-- è³ªå• 4: å­¦ç¿’ã‚¹ã‚¿ã‚¤ãƒ« (ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³) -->
                <div>
                    <label class="block text-lg font-medium text-gray-700 mb-2">4. ã©ã®å­¦ç¿’ã‚¹ã‚¿ã‚¤ãƒ«ãŒä¸€ç•ªãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¿ã¦ã¾ã™ã‹ï¼Ÿ</label>
                    <select id="q4-style" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="theory">ç†è«–/åº§å­¦ (æœ¬ã€å‹•ç”»ã€ã‚¤ãƒ³ãƒ—ãƒƒãƒˆä¸­å¿ƒ)</option>
                        <option value="practice">å®Ÿè·µ/ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ (å•é¡Œã‚’è§£ãã€æ‰‹ã‚’å‹•ã‹ã™ä¸­å¿ƒ)</option>
                        <option value="social">ä»–äººã¨ã®äº¤æµ (ã‚³ãƒ¼ãƒã€ä»²é–“ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­å¿ƒ)</option>
                        <option value="review">éå»å•/å¾©ç¿’ (åå¾©ã¨å®šç€ä¸­å¿ƒ)</option>
                    </select>
                </div>
                
                <!-- è³ªå• 5: æœ€åˆã®ã‚¿ã‚¹ã‚¯ã®é›£æ˜“åº¦ -->
                <div>
                    <label class="block text-lg font-medium text-gray-700 mb-2">5. æœ€åˆã®1é€±é–“ã§å–ã‚Šçµ„ã‚€ã‚¿ã‚¹ã‚¯ã®é›£æ˜“åº¦ãƒ¬ãƒ™ãƒ«ã¯ï¼Ÿ</label>
                    <select id="q5-difficulty" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="easy">ã€Œç°¡å˜ã™ãã¦ç¶šã‘ã‚‰ã‚Œã‚‹ã€ãƒ¬ãƒ™ãƒ«</option>
                        <option value="medium">ã€Œã¡ã‚‡ã£ã¨é ‘å¼µã‚Œã°é”æˆã§ãã‚‹ã€ãƒ¬ãƒ™ãƒ«</option>
                        <option value="hard">ã€ŒæŒ‘æˆ¦çš„ã§é›†ä¸­åŠ›ãŒå¿…è¦ã€ãªãƒ¬ãƒ™ãƒ«</option>
                    </select>
                </div>
            </div>

            <button id="generate-tasks-button" class="btn-primary px-6 py-3 rounded-xl font-semibold w-full mt-8 shadow-md hover:shadow-lg">
                è¡Œå‹•è¨ˆç”»ã‚’ç”Ÿæˆã—ã¦ç›®æ¨™ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
            </button>
            <div id="modal-status" class="mt-4 text-center text-gray-600 hidden">
                <div class="flex items-center justify-center space-x-2">
                    <div class="loading-spinner h-5 w-5 border-4 border-gray-200 rounded-full"></div>
                    <span>AIãŒæœ€é©ãªè¡Œå‹•è¨ˆç”»ã‚’è€ƒãˆä¸­ã§ã™...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- çµæœç”»é¢ï¼ˆå…¨ç”»é¢è¡¨ç¤ºï¼‰ -->
    <div id="result-screen" class="fixed inset-0 bg-white p-8 overflow-y-auto" style="display: none; z-index: 100;">
        <div class="container-box text-center">
            <h1 class="text-6xl font-extrabold text-teal-600 mb-4">
                ğŸ† ç›®æ¨™å®Œå…¨é”æˆ! ğŸ†
            </h1>
            <h2 class="text-3xl font-bold text-gray-800 mb-8">
                å…¨ã¦ã®ç›®æ¨™ã‚’é”æˆã—ã¾ã—ãŸï¼ç´ æ™´ã‚‰ã—ã„ã§ã™ï¼
            </h2>
            <button id="close-result-button" class="btn-primary px-8 py-3 rounded-xl font-semibold text-xl shadow-lg">
                ãƒªã‚¹ãƒˆç®¡ç†ç”»é¢ã«æˆ»ã‚‹
            </button>
        </div>
    </div>
    
    <!-- ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« (alert/confirm ä»£æ›¿) -->
    <div id="custom-modal-overlay" class="modal-overlay">
        <div class="modal-content p-8">
            <h3 id="custom-modal-title" class="text-xl font-bold text-gray-800 mb-4">ç¢ºèª</h3>
            <p id="custom-modal-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="custom-modal-cancel" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-semibold hover:bg-gray-300">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button id="custom-modal-confirm" class="bg-red-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-600">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // é–‹ç™ºç’°å¢ƒã§ã®ãƒ­ã‚®ãƒ³ã‚°ã‚’æœ‰åŠ¹åŒ–
        setLogLevel('debug');

        // --- Firebase/Canvas ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°è¨­å®š ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // --- DOMè¦ç´  ---
        const wishesListEl = document.getElementById('wishes-list');
        const goalTypeSelectEl = document.getElementById('goal-type-select');
        const generalGoalFieldsEl = document.getElementById('general-goal-fields');
        const wishInputEl = document.getElementById('wish-input');
        const criterionInputEl = document.getElementById('criterion-input');
        const deadlineInputEl = document.getElementById('deadline-input');
        const examGoalFieldsEl = document.getElementById('exam-goal-fields');
        const examNameInputEl = document.getElementById('exam-name-input');
        const targetScoreInputEl = document.getElementById('target-score-input');
        const examDateInputEl = document.getElementById('exam-date-input');
        const businessGoalFieldsEl = document.getElementById('business-goal-fields');
        const businessTargetInputEl = document.getElementById('business-target-input');
        const businessKpiInputEl = document.getElementById('business-kpi-input');
        const businessDeadlineInputEl = document.getElementById('business-deadline-input');
        const addWishButton = document.getElementById('add-wish-button');
        const emptyStateEl = document.getElementById('empty-state');
        const resultScreenEl = document.getElementById('result-screen');
        const closeResultButton = document.getElementById('close-result-button');
        const questionnaireModal = document.getElementById('questionnaire-modal');
        const generateTasksButton = document.getElementById('generate-tasks-button');
        const modalStatusEl = document.getElementById('modal-status');
        const q1LabelEl = document.getElementById('q1-label');
        const q1FieldEl = document.getElementById('q1-field');
        // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ 
        const customModalOverlay = document.getElementById('custom-modal-overlay');
        const customModalTitle = document.getElementById('custom-modal-title');
        const customModalMessage = document.getElementById('custom-modal-message');
        const customModalConfirmBtn = document.getElementById('custom-modal-confirm');
        const customModalCancelBtn = document.getElementById('custom-modal-cancel');


        let temporaryWishData = null; 
        let pendingConfirmation = null; // Promise resolve function for custom confirm

        // --- LLM API è¨­å®š ---
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const API_KEY = ""; 

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

        /**
         * ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° (alert/confirm ä»£æ›¿)
         */
        function customConfirm(message, title = 'ç¢ºèª') {
            return new Promise(resolve => {
                customModalTitle.textContent = title;
                customModalMessage.textContent = message;
                customModalOverlay.style.display = 'flex';

                // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
                customModalConfirmBtn.onclick = null;
                customModalCancelBtn.onclick = null;

                // æ–°ã—ã„ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                customModalConfirmBtn.onclick = () => {
                    customModalOverlay.style.display = 'none';
                    resolve(true);
                };
                customModalCancelBtn.onclick = () => {
                    customModalOverlay.style.display = 'none';
                    resolve(false);
                };
            });
        }

        /**
         * Exponential Backoffä»˜ããƒ•ã‚§ãƒƒãƒé–¢æ•°
         */
        async function fetchWithExponentialBackoff(url, options, retries = 5) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 429) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                } catch (error) {
                    if (i === retries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("API call failed after multiple retries.");
        }


        /**
         * ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«ä¿å­˜ã™ã‚‹
         */
        async function saveWishToFirestore(wishData) {
            if (!isAuthReady || !userId) {
                console.error("Firestore save failed: Auth not ready or userId missing.");
                return;
            }
            try {
                // Private data path: /artifacts/{appId}/users/{userId}/wishes
                const collectionRef = collection(db, 'artifacts', appId, 'users', userId, 'wishes');
                await addDoc(collectionRef, wishData);
                console.log("Wish saved successfully to Firestore.");
            } catch (error) {
                console.error("Error adding document: ", error);
                await customConfirm("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message, 'ã‚¨ãƒ©ãƒ¼');
            }
        }

        /**
         * Firestoreã®ç›®æ¨™ãƒªã‚¹ãƒˆã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹
         */
        function setupFirestoreListener() {
            if (!isAuthReady || !userId) return;

            // Private data path: /artifacts/{appId}/users/{userId}/wishes
            const collectionRef = collection(db, 'artifacts', appId, 'users', userId, 'wishes');
            
            onSnapshot(collectionRef, (snapshot) => {
                const fetchedWishes = [];
                snapshot.forEach(doc => {
                    fetchedWishes.push({ id: doc.id, ...doc.data() });
                });
                renderWishes(fetchedWishes);
                checkAllCompleted(fetchedWishes);
            }, (error) => {
                console.error("Error setting up Firestore listener: ", error);
                // customConfirm("ç›®æ¨™ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message, 'ã‚¨ãƒ©ãƒ¼');
            });
        }
        
        /**
         * Firebaseã®åˆæœŸåŒ–ã¨èªè¨¼
         */
        async function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                return;
            }
            
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        setupFirestoreListener(); // èªè¨¼å®Œäº†å¾Œã«ãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch(error) {
                            console.error("Authentication failed: ", error);
                            userId = crypto.randomUUID();
                            isAuthReady = true;
                        }
                    }
                    if (!userId) {
                        userId = crypto.randomUUID();
                        isAuthReady = true;
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                await customConfirm("ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚: " + error.message, 'ã‚¨ãƒ©ãƒ¼');
            }
        }

        // --- é€²æ—è¨ˆç®—ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function calculateProgress(wish) {
            const totalTasks = (wish.tasks || []).length;
            const completedTasks = (wish.tasks || []).filter(t => t.completed).length;
            const completionPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            const deadlineDate = wish.type === 'exam' ? wish.examDate : (wish.type === 'business' ? wish.deadline : wish.deadline);
            let daysLeft = 'æœŸé™ãªã—';
            let status = 'neutral';

            if (deadlineDate) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const deadline = new Date(deadlineDate);
                deadline.setHours(0, 0, 0, 0);

                const diffTime = deadline.getTime() - today.getTime();
                daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (daysLeft < 0 && !wish.completed) {
                    status = 'overdue';
                    daysLeft = Math.abs(daysLeft) + 'æ—¥è¶…é';
                } else if (daysLeft <= 7 && daysLeft >= 0 && !wish.completed) {
                    status = 'urgent';
                } else if (wish.completed) {
                    status = 'completed';
                    daysLeft = 'é”æˆæ¸ˆã¿';
                } else {
                    status = 'active';
                    daysLeft = daysLeft + 'æ—¥';
                }
            } else {
                status = 'active';
            }

            return { completionPercentage, daysLeft, status };
        }


        // --- DOMç”Ÿæˆ/ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---

        function renderWishes(currentWishes) {
            wishesListEl.innerHTML = ''; 

            if (currentWishes.length === 0) {
                emptyStateEl.style.display = 'block';
                return;
            } else {
                emptyStateEl.style.display = 'none';
            }

            currentWishes.forEach((wish) => {
                const wishCard = createWishCard(wish);
                wishesListEl.appendChild(wishCard);
            });
        }
        
        function checkAllCompleted(currentWishes) {
            const allCompleted = currentWishes.length > 0 && currentWishes.every(w => w.completed);
            
            if (allCompleted) {
                resultScreenEl.style.display = 'block';
                document.body.style.overflow = 'hidden'; 
            } else {
                resultScreenEl.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function createWishCard(wish) {
            const card = document.createElement('div');
            card.className = `p-6 rounded-xl shadow-2xl transition-shadow duration-300 ${wish.completed ? 'bg-green-50 border-4 border-green-500 shadow-green-200' : 'bg-white border-2 border-gray-100 hover:shadow-2xl'}`;

            // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†
            const header = document.createElement('div');
            header.className = 'flex justify-between items-start mb-4 pb-3 border-b border-gray-200';
            
            const titleGroup = document.createElement('div');
            titleGroup.className = 'flex items-center space-x-3';

            const completionCheckbox = document.createElement('input');
            completionCheckbox.type = 'checkbox';
            completionCheckbox.checked = wish.completed;
            completionCheckbox.className = 'w-5 h-5 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500';
            completionCheckbox.addEventListener('change', () => toggleWishCompletion(wish.id, wish));
            
            const title = document.createElement('h3');
            title.className = `text-2xl font-bold text-gray-800 ${wish.completed ? 'line-through text-green-600' : ''}`;
            
            let titleText = wish.title;
            let conditionLabel = 'æ¡ä»¶';
            let deadlineLabel = 'æœŸé™';
            let conditionText = wish.criterion || '<span class="text-red-500">æœªè¨­å®š</span>';
            let dateValue = wish.deadline;

            if (wish.type === 'exam') {
                 titleText = `${wish.examName} (${wish.targetScore}ç›®æ¨™)`;
                 title.title = `è©¦é¨“å: ${wish.examName}, ç›®æ¨™ç‚¹æ•°: ${wish.targetScore}`;
                 conditionLabel = 'ç›®æ¨™ç‚¹';
                 conditionText = wish.targetScore || '<span class="text-red-500">æœªè¨­å®š</span>';
                 deadlineLabel = 'è©¦é¨“æ—¥';
                 dateValue = wish.examDate;
            } else if (wish.type === 'business') {
                 titleText = wish.title;
                 title.title = `ç›®æ¨™: ${wish.title}, KPI: ${wish.kpi}`;
                 conditionLabel = 'KPI/æŒ‡æ¨™';
                 conditionText = wish.kpi || '<span class="text-red-500">æœªè¨­å®š</span>';
                 deadlineLabel = 'æœŸé™';
                 dateValue = wish.deadline; 
            }
            
            title.textContent = titleText;
            titleGroup.appendChild(completionCheckbox);
            titleGroup.appendChild(title);

            const deleteButton = document.createElement('button');
            deleteButton.className = 'text-gray-400 hover:text-red-500 transition-colors p-1 rounded-full';
            deleteButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            `;
            deleteButton.addEventListener('click', () => deleteWish(wish.id, titleText));

            header.appendChild(titleGroup);
            header.appendChild(deleteButton);
            card.appendChild(header);

            // é€²æ—ãƒãƒ¼ã¨ã‚µãƒãƒªãƒ¼
            const progress = calculateProgress(wish);
            let barColor = 'bg-blue-500';
            let summaryColor = 'text-blue-600';

            if (wish.completed) {
                barColor = 'bg-green-500';
                summaryColor = 'text-green-600';
            } else if (progress.status === 'urgent') {
                barColor = 'bg-red-500';
                summaryColor = 'text-red-600';
            } else if (progress.status === 'overdue') {
                barColor = 'bg-yellow-600';
                summaryColor = 'text-yellow-700';
            }

            const summarySection = document.createElement('div');
            summarySection.className = 'mb-6 p-4 bg-gray-50 rounded-lg border border-gray-100';
            summarySection.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="text-lg font-bold ${summaryColor}">é€²æ—: ${progress.completionPercentage}%</span>
                    <span class="text-sm font-medium text-gray-600">æ®‹ã‚Š/è¶…é: ${progress.daysLeft}</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill ${barColor}" style="width: ${progress.completionPercentage}%;"></div>
                </div>
            `;
            card.appendChild(summarySection);

            // æœŸé™ã¨æ¡ä»¶ã®è¡¨ç¤º
            const details = document.createElement('div');
            details.className = 'grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6 text-sm';

            const criterionDiv = document.createElement('div');
            criterionDiv.className = 'p-3 bg-gray-100 rounded-lg';
            criterionDiv.innerHTML = `<span class="font-bold text-gray-600">${conditionLabel}:</span> ${conditionText}`;

            const deadlineDiv = document.createElement('div');
            deadlineDiv.className = 'p-3 bg-gray-100 rounded-lg';
            const deadlineText = dateValue ? new Date(dateValue).toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' }) : '<span class="text-gray-500">è¨­å®šãªã—</span>';
            const deadlineColor = progress.status === 'overdue' ? 'text-red-600 font-bold' : 'text-gray-800';
            deadlineDiv.innerHTML = `<span class="font-bold text-gray-600">${deadlineLabel}:</span> <span class="${deadlineColor}">${deadlineText}</span>`;

            details.appendChild(criterionDiv);
            details.appendChild(deadlineDiv);
            card.appendChild(details);

            // AIãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ã‚³ãƒ¼ãƒãƒ³ã‚°
            const reviewSection = document.createElement('div');
            reviewSection.className = 'mt-4 pt-4 border-t border-gray-100';
            
            const reviewHeader = document.createElement('div');
            reviewHeader.className = 'flex justify-between items-center mb-3';
            reviewHeader.innerHTML = `<h4 class="text-lg font-semibold text-gray-700">ğŸ“£ AIã‚³ãƒ¼ãƒãƒ³ã‚°ï¼†ãƒ¬ãƒ“ãƒ¥ãƒ¼</h4>`;
            
            const reviewButton = document.createElement('button');
            reviewButton.className = 'bg-yellow-500 text-white text-sm px-4 py-2 rounded-lg font-semibold hover:bg-yellow-600 transition-colors shadow-md';
            reviewButton.textContent = 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼';
            reviewButton.disabled = wish.completed;
            reviewButton.addEventListener('click', async () => {
                reviewButton.disabled = true;
                reviewButton.textContent = 'åˆ†æä¸­...';
                await callGeminiForReview(wish.id, wish);
                reviewButton.textContent = 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼';
                reviewButton.disabled = wish.completed;
            });
            
            reviewHeader.appendChild(reviewButton);
            reviewSection.appendChild(reviewHeader);

            const reviewMessageEl = document.createElement('p');
            reviewMessageEl.className = 'text-sm text-gray-700 p-3 bg-yellow-50 rounded-lg italic border border-yellow-200';
            reviewMessageEl.innerHTML = wish.lastReview || 'ã€Œãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€AIã‹ã‚‰é€²æ—çŠ¶æ³ã®åˆ†æã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å—ã‘å–ã‚Šã¾ã—ã‚‡ã†ï¼';
            reviewSection.appendChild(reviewMessageEl);
            card.appendChild(reviewSection);

            // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ
            const tasksHeader = document.createElement('div');
            tasksHeader.className = 'flex justify-between items-center mb-3 mt-8';
            tasksHeader.innerHTML = `<h4 class="text-xl font-bold text-gray-800">âœ… è¡Œå‹•è¨ˆç”» (${progress.completionPercentage}%)</h4>`;
            card.appendChild(tasksHeader);

            const tasksList = document.createElement('ul');
            tasksList.className = 'space-y-3 pl-2';
            
            if (!wish.tasks || wish.tasks.length === 0) {
                const noTask = document.createElement('p');
                noTask.className = 'text-gray-500 text-sm italic';
                noTask.textContent = 'è¡Œå‹•è¨ˆç”»ã¯ã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                tasksList.appendChild(noTask);
            } else {
                wish.tasks.forEach((task, taskIndex) => {
                    const taskItem = createTaskItem(task, wish.id, wish, taskIndex);
                    tasksList.appendChild(taskItem);
                });
            }
            card.appendChild(tasksList);

            // æ–°ã—ã„ã‚¿ã‚¹ã‚¯ãƒ•ã‚©ãƒ¼ãƒ 
            const addTaskForm = document.createElement('div');
            addTaskForm.className = 'flex mt-4 pt-4 border-t border-gray-100 gap-2';
            
            const taskInput = document.createElement('input');
            taskInput.type = 'text';
            taskInput.placeholder = 'æ–°ã—ã„ã‚¹ãƒ†ãƒƒãƒ—ã‚’å…¥åŠ› (æ‰‹å‹•)';
            taskInput.className = 'flex-grow p-2 text-sm border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500';
            
            const addTaskBtn = document.createElement('button');
            addTaskBtn.className = 'bg-gray-200 text-gray-800 text-sm px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors whitespace-nowrap';
            addTaskBtn.textContent = 'è¿½åŠ ';
            addTaskBtn.addEventListener('click', () => addTask(wish.id, wish, taskInput.value));

            taskInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    addTask(wish.id, wish, taskInput.value);
                }
            });

            addTaskForm.appendChild(taskInput);
            addTaskForm.appendChild(addTaskBtn);
            card.appendChild(addTaskForm);

            return card;
        }

        function createTaskItem(task, wishId, wish, taskIndex) {
            const listItem = document.createElement('li');
            listItem.className = 'task-item p-2 rounded-lg hover:bg-gray-100 transition-colors';

            const taskTextContainer = document.createElement('div');
            taskTextContainer.className = 'flex items-start space-x-2 mr-2';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = task.completed;
            checkbox.className = 'w-4 h-4 mt-1 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 flex-shrink-0';
            checkbox.addEventListener('change', () => toggleTaskCompletion(wishId, wish, taskIndex));

            const textWrapper = document.createElement('div');
            textWrapper.className = 'flex-grow min-w-0';

            const textSpan = document.createElement('span');
            textSpan.id = `task-text-${wishId}-${taskIndex}`;
            textSpan.className = `text-gray-700 text-base break-words ${task.completed ? 'line-through text-gray-500 italic' : ''}`;
            
            const priorityTag = task.priority ? `<span class="text-xs font-semibold py-0.5 px-2 rounded-full ${getPriorityClass(task.priority)} flex-shrink-0 mr-2">${task.priority}</span>` : '';
            textSpan.innerHTML = priorityTag + task.description;

            textWrapper.appendChild(textSpan);
            taskTextContainer.appendChild(checkbox);
            taskTextContainer.appendChild(textWrapper);

            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ
            const actionContainer = document.createElement('div');
            actionContainer.className = 'flex space-x-1 flex-shrink-0';
            
            // ç·¨é›†ãƒœã‚¿ãƒ³
            const editButton = document.createElement('button');
            editButton.className = 'text-gray-400 hover:text-blue-500 transition-colors p-1 rounded-full';
            editButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7 1l4-4m-4 4l-4 4m8-8l-4 4m-4 4l-4-4"/></svg>`;
            editButton.title = 'ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†';
            editButton.addEventListener('click', () => editTaskInline(wishId, wish, taskIndex, textSpan));
            
            // å‰Šé™¤ãƒœã‚¿ãƒ³
            const deleteButton = document.createElement('button');
            deleteButton.className = 'text-gray-400 hover:text-red-500 transition-colors p-1 rounded-full';
            deleteButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            `;
            deleteButton.title = 'ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤';
            deleteButton.addEventListener('click', () => deleteTask(wishId, wish, taskIndex));

            actionContainer.appendChild(editButton);
            actionContainer.appendChild(deleteButton);

            listItem.appendChild(taskTextContainer);
            listItem.appendChild(actionContainer);
            return listItem;
        }
        
        function editTaskInline(wishId, wish, taskIndex, textSpanEl) {
            const currentTask = wish.tasks[taskIndex];
            const currentDescription = currentTask.description;
            
            // æ—¢å­˜ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’éè¡¨ç¤ºã«ã—ã€ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
            textSpanEl.style.display = 'none';

            const editForm = document.createElement('div');
            editForm.className = 'flex flex-col space-y-2 w-full';

            // è¨˜è¿°ç·¨é›†ã‚¤ãƒ³ãƒ—ãƒƒãƒˆ
            const inputEl = document.createElement('input');
            inputEl.type = 'text';
            inputEl.value = currentDescription;
            inputEl.className = 'p-1 text-sm border border-blue-300 rounded focus:ring-blue-500';
            
            // å„ªå…ˆåº¦ã‚»ãƒ¬ã‚¯ãƒˆ
            const prioritySelect = document.createElement('select');
            prioritySelect.className = 'p-1 text-xs border border-blue-300 rounded focus:ring-blue-500 w-24';
            ['é«˜', 'ä¸­', 'ä½', 'æ‰‹å‹•'].forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = p;
                if (currentTask.priority === p) option.selected = true;
                prioritySelect.appendChild(option);
            });
            
            // ä¿å­˜ãƒœã‚¿ãƒ³
            const saveButton = document.createElement('button');
            saveButton.textContent = 'ä¿å­˜';
            saveButton.className = 'bg-blue-500 text-white text-xs px-2 py-1 rounded hover:bg-blue-600 transition-colors';
            saveButton.addEventListener('click', () => {
                updateTask(wishId, wish, taskIndex, inputEl.value.trim(), prioritySelect.value);
                // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’å†è¡¨ç¤º
                editForm.remove();
                textSpanEl.style.display = 'block'; 
            });

            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
            cancelButton.className = 'bg-gray-300 text-gray-800 text-xs px-2 py-1 rounded hover:bg-gray-400 transition-colors';
            cancelButton.addEventListener('click', () => {
                // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’å†è¡¨ç¤º
                editForm.remove();
                textSpanEl.style.display = 'block';
            });
            
            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'flex space-x-2';
            buttonGroup.appendChild(saveButton);
            buttonGroup.appendChild(cancelButton);

            editForm.appendChild(inputEl);
            editForm.appendChild(prioritySelect);
            editForm.appendChild(buttonGroup);

            // textSpanã®è¦ªè¦ç´ ï¼ˆtextWrapperï¼‰ã®ç›´å‰ã«æŒ¿å…¥
            textSpanEl.parentNode.insertBefore(editForm, textSpanEl);
        }

        function getPriorityClass(priority) {
            switch (priority) {
                case 'é«˜': return 'bg-red-200 text-red-800';
                case 'ä¸­': return 'bg-yellow-200 text-yellow-800';
                case 'ä½': return 'bg-blue-200 text-blue-800';
                case 'æ‰‹å‹•': return 'bg-gray-300 text-gray-700';
                default: return 'bg-gray-300 text-gray-700';
            }
        }


        // --- CRUD/æ›´æ–°æ“ä½œ ---
        
        async function updateTask(wishId, wish, taskIndex, newDescription, newPriority) {
            if (!db || !userId) return console.error("Firestore not initialized.");
            if (!newDescription) return;

            const updatedTasks = [...wish.tasks];
            updatedTasks[taskIndex].description = newDescription;
            updatedTasks[taskIndex].priority = newPriority;

            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'wishes', wishId);
                await updateDoc(docRef, { 
                    tasks: updatedTasks
                });
            } catch (error) {
                console.error("Error updating task: ", error);
                await customConfirm("ã‚¿ã‚¹ã‚¯ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message, 'ã‚¨ãƒ©ãƒ¼');
            }
        }


        async function toggleWishCompletion(wishId, wish) {
            const newCompletedState = !wish.completed;
            const updatedTasks = wish.tasks.map(t => ({ ...t, completed: newCompletedState }));

            if (!db || !userId) return console.error("Firestore not initialized.");
            
            const confirmed = await customConfirm(
                newCompletedState 
                ? `ç›®æ¨™ã€Œ${wish.title}ã€ã‚’å®Œäº†æ¸ˆã¿ã«ã—ã¾ã™ã‹ï¼Ÿï¼ˆæœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚‚å…¨ã¦å®Œäº†ã«ãªã‚Šã¾ã™ï¼‰`
                : `ç›®æ¨™ã€Œ${wish.title}ã€ã‚’æœªå®Œäº†ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿï¼ˆå…¨ã¦ã®ã‚¿ã‚¹ã‚¯ã‚‚æœªå®Œäº†ã«æˆ»ã‚Šã¾ã™ï¼‰`
            );
            if (!confirmed) return;

            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'wishes', wishId);
                await updateDoc(docRef, { 
                    completed: newCompletedState,
                    tasks: updatedTasks 
                });
            } catch (error) {
                console.error("Error updating document: ", error);
                await customConfirm("ç›®æ¨™ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message, 'ã‚¨ãƒ©ãƒ¼');
            }
        }

        async function deleteWish(wishId, title) {
            if (!db || !userId) return console.error("Firestore not initialized.");
            
            const confirmed = await customConfirm(`ç›®æ¨™ã€Œ${title}ã€ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`, 'ç›®æ¨™å‰Šé™¤');
            if (!confirmed) return;

            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'wishes', wishId);
                await deleteDoc(docRef);
            } catch (error) {
                console.error("Error deleting document: ", error);
                await customConfirm("ç›®æ¨™ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message, 'ã‚¨ãƒ©ãƒ¼');
            }
        }

        async function addTask(wishId, wish, description) {
            const taskDesc = description.trim();
            if (!taskDesc || !db || !userId) return;

            const newTasks = [...(wish.tasks || []), {
                description: taskDesc,
                completed: false,
                priority: 'æ‰‹å‹•'
            }];

            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'wishes', wishId);
                await updateDoc(docRef, { 
                    tasks: newTasks
                });
            } catch (error) {
                console.error("Error adding task: ", error);
                await customConfirm("ã‚¿ã‚¹ã‚¯ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message, 'ã‚¨ãƒ©ãƒ¼');
            }
        }

        async function toggleTaskCompletion(wishId, wish, taskIndex) {
            if (!db || !userId) return console.error("Firestore not initialized.");
            
            const updatedTasks = [...wish.tasks];
            updatedTasks[taskIndex].completed = !updatedTasks[taskIndex].completed;
            
            const allTasksCompleted = updatedTasks.every(t => t.completed);

            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'wishes', wishId);
                await updateDoc(docRef, { 
                    tasks: updatedTasks,
                    completed: allTasksCompleted // å…¨ã‚¿ã‚¹ã‚¯å®Œäº†ãªã‚‰ç›®æ¨™ã‚‚å®Œäº†
                });
            } catch (error) {
                console.error("Error updating task status: ", error);
                await customConfirm("ã‚¿ã‚¹ã‚¯çŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message, 'ã‚¨ãƒ©ãƒ¼');
            }
        }
        
        async function deleteTask(wishId, wish, taskIndex) {
            if (!db || !userId) return console.error("Firestore not initialized.");
            
            const confirmed = await customConfirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', 'ã‚¿ã‚¹ã‚¯å‰Šé™¤');
            if (!confirmed) return;

            const updatedTasks = [...wish.tasks];
            updatedTasks.splice(taskIndex, 1);

            const allTasksCompleted = updatedTasks.every(t => t.completed);

            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'wishes', wishId);
                await updateDoc(docRef, { 
                    tasks: updatedTasks,
                    completed: allTasksCompleted // å…¨ã‚¿ã‚¹ã‚¯å®Œäº†ãªã‚‰ç›®æ¨™ã‚‚å®Œäº†
                });
            } catch (error) {
                console.error("Error deleting task: ", error);
                await customConfirm("ã‚¿ã‚¹ã‚¯ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message, 'ã‚¨ãƒ©ãƒ¼');
            }
        }


        // --- ç›®æ¨™ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ ---
        function toggleGoalFields() {
            const selectedType = goalTypeSelectEl.value;
            
            generalGoalFieldsEl.classList.add('hidden');
            examGoalFieldsEl.classList.add('hidden');
            businessGoalFieldsEl.classList.add('hidden');

            if (selectedType === 'general') {
                generalGoalFieldsEl.classList.remove('hidden');
            } else if (selectedType === 'exam') {
                examGoalFieldsEl.classList.remove('hidden');
            } else if (selectedType === 'business') {
                businessGoalFieldsEl.classList.remove('hidden');
            }
        }


        // --- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¨ã‚¿ã‚¹ã‚¯ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ---

        function openQuestionnaire() {
            const goalType = goalTypeSelectEl.value;
            let isValid = true;
            let titleText = '';

            if (goalType === 'general') {
                const title = wishInputEl.value.trim();
                const deadline = deadlineInputEl.value;
                if (!title) { isValid = false; customConfirm('ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'å…¥åŠ›ä¸è¶³'); }
                titleText = title;
                temporaryWishData = { type: 'general', title, criterion: criterionInputEl.value.trim(), deadline, completed: false, tasks: [] };
                
                q1LabelEl.textContent = '1. ã‚ãªãŸã®ç›®æ¨™ã®ä¸»ãªåˆ†é‡ã¯ï¼Ÿ';
                q1FieldEl.innerHTML = `<option value="language">èªå­¦å­¦ç¿’ (è‹±èªã€ä»–è¨€èª)</option><option value="programming">IT / ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°</option><option value="finance">é‡‘è / æŠ•è³‡</option><option value="fitness">èº«ä½“èƒ½åŠ› / ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹</option><option>å‰µé€ æ´»å‹• / è¶£å‘³</option><option>ç”Ÿæ´»ç¿’æ…£æ”¹å–„ / å¥åº·</option><option>ãã®ä»–</option>`;
                
            } else if (goalType === 'exam') {
                const examName = examNameInputEl.value.trim();
                const targetScore = targetScoreInputEl.value.trim();
                const examDate = examDateInputEl.value;
                if (!examName || !targetScore || !examDate) { isValid = false; customConfirm('è©¦é¨“åã€ç›®æ¨™ç‚¹æ•°ã€è©¦é¨“æ—¥ã‚’å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'å…¥åŠ›ä¸è¶³'); }
                titleText = `${examName}ã§${targetScore}ç‚¹ã‚’å–ã‚‹`;
                temporaryWishData = { type: 'exam', title: titleText, examName, targetScore, examDate, completed: false, tasks: [] };
                
                q1LabelEl.textContent = '1. å—é¨“ãƒ»è³‡æ ¼è©¦é¨“ã®ä¸»ãªå¯¾è±¡ç§‘ç›®ã‚„åˆ†é‡ã¯ï¼Ÿ';
                q1FieldEl.innerHTML = `<option value="english">è‹±èª</option><option value="math">æ•°å­¦</option><option value="science">ç†ç§‘ (ç‰©ç†ã€åŒ–å­¦ã€ç”Ÿç‰©)</option><option value="social">ç¤¾ä¼š (æ­´å²ã€åœ°ç†ã€å…¬æ°‘)</option><option value="japanese">å›½èª</option><option>å°‚é–€ç§‘ç›®</option>`;

            } else if (goalType === 'business') {
                const title = businessTargetInputEl.value.trim();
                const kpi = businessKpiInputEl.value.trim();
                const deadline = businessDeadlineInputEl.value;
                if (!title || !kpi || !deadline) { isValid = false; customConfirm('ç›®æ¨™ã€KPI/æŒ‡æ¨™ã€æœŸé™ã‚’å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'å…¥åŠ›ä¸è¶³'); }
                titleText = title;
                temporaryWishData = { type: 'business', title, kpi, deadline, completed: false, tasks: [] };
                
                q1LabelEl.textContent = '1. ãƒ“ã‚¸ãƒã‚¹ç›®æ¨™ã®ä¸»ãªé ˜åŸŸã¯ï¼Ÿ';
                q1FieldEl.innerHTML = `<option value="sales">å–¶æ¥­ãƒ»å£²ä¸Šå‘ä¸Š</option><option value="marketing">ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ãƒ»ãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°</option><option value="project">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ãƒ»é”æˆ</option><option value="development">è£½å“é–‹ç™ºãƒ»æ”¹å–„</option><option value="management">çµ„ç¹”ãƒ»ãƒãƒ¼ãƒ ç®¡ç†</option><option>è‡ªå·±å•“ç™ºãƒ»ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—</option><option>ãã®ä»–</option>`;
            }

            if (!isValid) return;

            questionnaireModal.style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        async function generateTasksFromQuestionnaire() {
            if (!temporaryWishData) return;

            const q1Field = document.getElementById('q1-field').value;
            const q2Level = document.getElementById('q2-level').value;
            const q3Time = document.getElementById('q3-time').value;
            const q4Style = document.getElementById('q4-style').value;
            const q5Difficulty = document.getElementById('q5-difficulty').value;

            generateTasksButton.disabled = true;
            modalStatusEl.classList.remove('hidden');

            try {
                const generatedTasks = await callGeminiForTasks(
                    temporaryWishData,
                    q1Field, q2Level, q3Time, q4Style, q5Difficulty
                );

                const finalWishData = {
                    ...temporaryWishData,
                    tasks: generatedTasks,
                    lastReview: null // AIãƒ¬ãƒ“ãƒ¥ãƒ¼ã®åˆæœŸåŒ–
                };
                await saveWishToFirestore(finalWishData);

                clearInputFields();
                questionnaireModal.style.display = 'none';
                document.body.classList.remove('modal-open');
                
            } catch (error) {
                console.error("Task generation failed:", error);
                await customConfirm("è¡Œå‹•è¨ˆç”»ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ç½®ã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„: " + error.message, 'ã‚¨ãƒ©ãƒ¼');
            } finally {
                generateTasksButton.disabled = false;
                modalStatusEl.classList.add('hidden');
                temporaryWishData = null;
            }
        }
        
        function clearInputFields() {
            wishInputEl.value = '';
            criterionInputEl.value = '';
            deadlineInputEl.value = '';
            examNameInputEl.value = '';
            targetScoreInputEl.value = '';
            examDateInputEl.value = '';
            businessTargetInputEl.value = '';
            businessKpiInputEl.value = '';
            businessDeadlineInputEl.value = '';
        }

        async function callGeminiForTasks(wishData, q1Field, q2Level, q3Time, q4Style, q5Difficulty) {
            
            let goalDescription = "";
            let deadlineText = "";

            if (wishData.type === 'exam') {
                goalDescription = `å—é¨“ç›®æ¨™: ${wishData.examName}ã§${wishData.targetScore}ç‚¹ã‚’å–ã‚‹ã€‚`;
                deadlineText = `è©¦é¨“æ—¥: ${wishData.examDate}ã€‚`;
            } else if (wishData.type === 'business') {
                 goalDescription = `ãƒ“ã‚¸ãƒã‚¹ãƒ»ã‚­ãƒ£ãƒªã‚¢ç›®æ¨™: ã€Œ${wishData.title}ã€ã€é”æˆKPI/æŒ‡æ¨™: ã€Œ${wishData.kpi}ã€ã€‚`;
                 deadlineText = `æœŸé™: ${wishData.deadline}ã€‚`;
            } else {
                goalDescription = `ç›®æ¨™: ã€Œ${wishData.title}ã€ã€é”æˆæ¡ä»¶: ã€Œ${wishData.criterion || 'ãªã—'}ã€ã€‚`;
                deadlineText = `æœŸé™: ${wishData.deadline || 'ãªã—'}ã€‚`;
            }


            const userQuery = `
                ${goalDescription}
                ${deadlineText}
                
                ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›®æ¨™è¨­å®šï¼ˆè©³ç´°ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœï¼‰:
                1. ä¸»ãªåˆ†é‡/é ˜åŸŸ: ${q1Field}
                2. ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«: ${q2Level}
                3. 1æ—¥ã«ç¢ºä¿ã§ãã‚‹æ™‚é–“/ãƒªã‚½ãƒ¼ã‚¹: ${q3Time}
                4. å­¦ç¿’/ä½œæ¥­ã‚¹ã‚¿ã‚¤ãƒ«: ${q4Style}
                5. æœ€åˆã®ã‚¿ã‚¹ã‚¯ã®é›£æ˜“åº¦: ${q5Difficulty}

                ä¸Šè¨˜ã®æƒ…å ±ã‚’å‚è€ƒã«ã€ç›®æ¨™é”æˆã«å‘ã‘ãŸå…·ä½“çš„ãªã‚¹ãƒ†ãƒƒãƒ—ã¨ãªã‚‹ã‚¿ã‚¹ã‚¯ã‚’5ã€œ7å€‹ã€æ—¥æœ¬èªã§ä½œæˆã—ã¦ãã ã•ã„ã€‚
                ã‚¿ã‚¹ã‚¯ã¯ã€SMARTåŸå‰‡ã«åŸºã¥ãã€å®Ÿè¡Œå¯èƒ½ã§è¨ˆæ¸¬å¯èƒ½ã§ã‚ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
                æœŸé™ã¨ç¢ºä¿ã§ãã‚‹æ™‚é–“ã‹ã‚‰é€†ç®—ã—ã¦ã€Œé«˜ã€ã€Œä¸­ã€ã€Œä½ã€ã®å„ªå…ˆåº¦ã‚’å‰²ã‚ŠæŒ¯ã£ã¦ãã ã•ã„ã€‚
                æœ€åˆã®1ã€œ2å€‹ã®ã‚¿ã‚¹ã‚¯ã¯ã€è³ªå•5ã®é›£æ˜“åº¦ãƒ¬ãƒ™ãƒ«ã‚’åæ˜ ã•ã›ã¦ãã ã•ã„ã€‚
            `;

            const systemPrompt = "ã‚ãªãŸã¯ç›®æ¨™è¨­å®šã¨è¨ˆç”»ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›®æ¨™ã¨è©³ç´°ãªã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ã«åŸºã¥ãã€å…·ä½“çš„ãªã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’JSONå½¢å¼ã§æä¾›ã—ã¦ãã ã•ã„ã€‚";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "description": { "type": "STRING", "description": "ã‚¿ã‚¹ã‚¯ã®å…·ä½“çš„ãªå†…å®¹ï¼ˆå®Ÿè¡Œå¯èƒ½ã§è¨ˆæ¸¬å¯èƒ½ãªæ—¥æœ¬èªã®æ–‡ç« ï¼‰" },
                                "priority": { "type": "STRING", "description": "ã‚¿ã‚¹ã‚¯ã®é‡è¦åº¦ã€‚å¿…ãšã€Œé«˜ã€ã€Œä¸­ã€ã€Œä½ã€ã®ã„ãšã‚Œã‹ã‚’é¸æŠã—ã¦ãã ã•ã„" },
                                "completed": { "type": "BOOLEAN", "description": "åˆæœŸçŠ¶æ…‹ã¯å¿…ãšfalseã«ã—ã¦ãã ã•ã„" }
                            },
                            required: ["description", "priority", "completed"]
                        }
                    }
                }
            };
            
            const apiUrlWithKey = `${API_URL}?key=${API_KEY}`;
            const response = await fetchWithExponentialBackoff(apiUrlWithKey, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            
            if (result.candidates && result.candidates.length > 0 && 
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                
                const jsonText = result.candidates[0].content.parts[0].text;
                const parsedJson = JSON.parse(jsonText);
                
                return parsedJson.map(task => ({
                    ...task,
                    completed: false
                }));

            } else {
                throw new Error("AIã‹ã‚‰ã®è¡Œå‹•è¨ˆç”»ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        }

        // --- AIãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ ---

        async function callGeminiForReview(wishId, wish) {
            
            const progress = calculateProgress(wish);
            const totalTasks = (wish.tasks || []).length;
            const completedTasks = (wish.tasks || []).filter(t => t.completed).length;
            const incompleteTasks = (wish.tasks || []).filter(t => !t.completed);
            
            let deadlineInfo = '';
            if (progress.status === 'overdue') {
                deadlineInfo = `æœŸé™ã‚’${progress.daysLeft}è¶…éã—ã¦ã„ã¾ã™ã€‚`;
            } else if (progress.status === 'urgent') {
                deadlineInfo = `æœŸé™ã¾ã§æ®‹ã‚Š${progress.daysLeft}ã§ã™ã€‚éå¸¸ã«ç·Šæ€¥ã§ã™ã€‚`;
            } else if (progress.status === 'active') {
                deadlineInfo = `æœŸé™ã¾ã§æ®‹ã‚Š${progress.daysLeft}ã§ã™ã€‚`;
            } else if (progress.status === 'completed') {
                // å®Œäº†æ¸ˆã¿ç›®æ¨™ã«ã¯ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸è¦ã ãŒã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™
                const message = "ã“ã®ç›®æ¨™ã¯ã™ã§ã«é”æˆæ¸ˆã¿ã§ã™ï¼ç´ æ™´ã‚‰ã—ã„æˆæœã§ã™ã€‚æ¬¡ã®ç›®æ¨™ã«æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ï¼";
                 await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'wishes', wishId), { lastReview: message });
                 return;
            } else {
                deadlineInfo = 'æœŸé™è¨­å®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
            }

            const statusReport = `
                ç›®æ¨™: ${wish.title}
                é€²æ—: ${progress.completionPercentage}% (${completedTasks}/${totalTasks}ã‚¿ã‚¹ã‚¯å®Œäº†)
                æœŸé™æƒ…å ±: ${deadlineInfo}
                æ®‹ã£ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ï¼ˆ${incompleteTasks.length}å€‹ï¼‰:
                ${incompleteTasks.map(t => `- [${t.priority}] ${t.description}`).join('\n')}
            `;

            const userQuery = `
                ä»¥ä¸‹ã®ç›®æ¨™ã®é€²æ—ãƒ¬ãƒãƒ¼ãƒˆã‚’åˆ†æã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆã‚ã›ãŸãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚
                ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯ä»¥ä¸‹ã®ç‚¹ã‚’å«ã‚ã¦ãã ã•ã„:
                1. ç¾çŠ¶ã®è‚¯å®šçš„ãªè©•ä¾¡ï¼ˆé ‘å¼µã£ã¦ã„ã‚‹ç‚¹ï¼‰
                2. è¨ˆç”»ä¿®æ­£ã‚„åŠ é€Ÿã®ãŸã‚ã®å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆä¾‹ï¼šé«˜å„ªå…ˆåº¦ã®ã‚¿ã‚¹ã‚¯ã«é›†ä¸­ã€æ™‚é–“ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã®ææ¡ˆãªã©ï¼‰
                3. æœ€å¾Œã¯ãƒã‚¸ãƒ†ã‚£ãƒ–ã§æ¸©ã‹ã„åŠ±ã¾ã—ã®è¨€è‘‰ã§ç· ã‚ããã‚‹ã“ã¨ã€‚
                ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è¦ªã—ã¿ã‚„ã™ã„æ—¥æœ¬èªã§ã€150æ–‡å­—ç¨‹åº¦ã§ç°¡æ½”ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚
                ---ãƒ¬ãƒãƒ¼ãƒˆ---
                ${statusReport}
            `;

            const systemPrompt = "ã‚ãªãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚³ãƒ¼ãƒã§ã‚ã‚Šã€è¨ˆç”»ã®é€²æ—ã‚’åˆ†æã—ã€å…·ä½“çš„ã‹ã¤ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é«˜ã‚ã‚‹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›ã™ã‚‹ã®ãŒå½¹å‰²ã§ã™ã€‚";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const apiUrlWithKey = `${API_URL}?key=${API_KEY}`;
            const response = await fetchWithExponentialBackoff(apiUrlWithKey, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            
            if (result.candidates && result.candidates.length > 0 && 
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                
                const reviewText = result.candidates[0].content.parts[0].text;
                
                // Firestoreã«ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ä¿å­˜ã—ã¦UIã‚’æ›´æ–°
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'wishes', wishId), { lastReview: reviewText });
                } catch (error) {
                    console.error("Error saving review: ", error);
                    await customConfirm("ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message, 'ã‚¨ãƒ©ãƒ¼');
                }
            } else {
                await customConfirm("AIãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", 'ã‚¨ãƒ©ãƒ¼');
            }
        }


        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
        goalTypeSelectEl.addEventListener('change', () => {
            toggleGoalFields();
            q1FieldEl.innerHTML = '';
        });
        addWishButton.addEventListener('click', openQuestionnaire);
        generateTasksButton.addEventListener('click', generateTasksFromQuestionnaire);
        closeResultButton.addEventListener('click', () => {
             resultScreenEl.style.display = 'none';
             document.body.style.overflow = 'auto';
        });

        // Enterã‚­ãƒ¼ã§ã®ç›®æ¨™è¿½åŠ ã‚’ã‚µãƒãƒ¼ãƒˆ
        [wishInputEl, criterionInputEl, examNameInputEl, targetScoreInputEl, businessTargetInputEl, businessKpiInputEl].forEach(el => {
            el.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    openQuestionnaire();
                }
            });
        });

        // --- åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã®å®Ÿè¡Œ ---
        window.onload = function() {
            initFirebase();
            toggleGoalFields(); 
        };
        
        // window.confirm/alert ã®ã‚«ã‚¹ã‚¿ãƒ ä»£æ›¿æ©Ÿèƒ½ã‚’ä½¿ç”¨
        window.confirm = customConfirm;
        window.alert = (message) => customConfirm(message, 'ãŠçŸ¥ã‚‰ã›');
    </script>

</body>
</html>